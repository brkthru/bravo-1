# Field Calculations Documentation

This document outlines which fields are provided as input versus calculated by the system for Campaigns and Line Items.

## Campaign Fields

### Input Fields (Provided by Client/ETL)

| Field                     | Type    | Description                                       |
| ------------------------- | ------- | ------------------------------------------------- |
| `name`                    | string  | Campaign name                                     |
| `campaignNumber`          | string  | Unique campaign identifier                        |
| `status`                  | string  | Campaign status (active, paused, completed, etc.) |
| `accountId`               | string  | Associated account ID                             |
| `accountName`             | string  | Associated account name                           |
| `team.leadAccountManager` | object  | Lead account manager details                      |
| `team.mediaTrader`        | object  | Media trader details (optional)                   |
| `dates.start`             | Date    | Campaign start date                               |
| `dates.end`               | Date    | Campaign end date                                 |
| `budget.total`            | number  | Total campaign budget                             |
| `budget.allocated`        | number  | Allocated budget amount                           |
| `budget.spent`            | number  | Amount spent so far                               |
| `metrics.*`               | various | Any raw metrics provided                          |
| `mediaActivity`           | string  | Media activity description                        |

### Calculated Fields (Generated by System)

| Field                                   | Type     | Calculation                 | Description                     |
| --------------------------------------- | -------- | --------------------------- | ------------------------------- |
| `_id`                                   | ObjectId | `new ObjectId()`            | MongoDB document ID             |
| `createdAt`                             | Date     | `new Date()`                | Record creation timestamp       |
| `updatedAt`                             | Date     | `new Date()`                | Last update timestamp           |
| `budget.remaining`                      | number   | `total - spent`             | Remaining budget                |
| `calculatedFields.allocationPercentage` | object   | `(allocated / total) * 100` | Percentage of budget allocated  |
| `calculatedFields.spendPercentage`      | object   | `(spent / total) * 100`     | Percentage of budget spent      |
| `dates.daysElapsed`                     | number   | `now - start`               | Days since campaign started     |
| `dates.totalDuration`                   | number   | `end - start`               | Total campaign duration in days |
| `metrics.deliveryPacing`                | number   | Dynamic calculation         | Delivery pacing percentage      |
| `metrics.spendPacing`                   | number   | Dynamic calculation         | Spend pacing percentage         |
| `metrics.marginActual`                  | number   | Revenue-based calculation   | Actual margin achieved          |

### Calculated Field Structure

Each calculated field includes metadata:

```javascript
{
  value: Decimal128,           // The calculated value
  calculationVersion: string,  // Version of calculation engine used (e.g., "1.0.0")
  calculatedAt: Date,         // When calculation was performed
  context: string,            // Context of calculation (e.g., "campaign_budget")
  formula: string             // Formula reference (e.g., "marginPercentage")
}
```

## Line Item Fields

### Input Fields (Provided by Client/ETL)

| Field            | Type   | Description                               |
| ---------------- | ------ | ----------------------------------------- |
| `name`           | string | Line item name                            |
| `description`    | string | Line item description                     |
| `strategyId`     | string | Parent strategy ID                        |
| `campaignId`     | string | Parent campaign ID                        |
| `audience`       | string | Target audience                           |
| `geo`            | string | Geographic targeting                      |
| `targeting`      | string | Additional targeting criteria             |
| `adFormats`      | string | Ad format types                           |
| `dates.start`    | Date   | Line item start date                      |
| `dates.end`      | Date   | Line item end date                        |
| `price`          | number | Total price                               |
| `unitPrice`      | number | Price per unit                            |
| `mediaBudget`    | number | Media budget allocation                   |
| `targetUnitCost` | number | Target cost per unit                      |
| `targetMargin`   | number | Target margin percentage                  |
| `channelId`      | number | Channel ID reference                      |
| `tacticId`       | number | Tactic ID reference                       |
| `unitType`       | string | Type of units (impressions, clicks, etc.) |
| `plannedUnits`   | number | Number of units planned                   |

### Calculated Fields (Generated by System)

| Field              | Type     | Calculation                          | Description                   |
| ------------------ | -------- | ------------------------------------ | ----------------------------- |
| `_id`              | ObjectId | `new ObjectId()`                     | MongoDB document ID           |
| `createdAt`        | Date     | `new Date()`                         | Record creation timestamp     |
| `updatedAt`        | Date     | `new Date()`                         | Last update timestamp         |
| `actualUnitCost`   | object   | `spend / deliveredUnits`             | Actual cost per unit achieved |
| `marginAmount`     | object   | `revenue - cost`                     | Margin in dollars             |
| `marginPercentage` | object   | `((revenue - cost) / revenue) * 100` | Margin as percentage          |
| `profitAmount`     | object   | `revenue - cost`                     | Profit amount                 |
| `pacing.spend`     | object   | Based on dates and spend             | Spend pacing percentage       |
| `pacing.delivery`  | object   | Based on dates and units             | Delivery pacing percentage    |
| `performance.cpm`  | object   | `(cost / impressions) * 1000`        | Cost per thousand impressions |
| `performance.cpc`  | object   | `cost / clicks`                      | Cost per click                |
| `performance.cpa`  | object   | `cost / conversions`                 | Cost per acquisition          |

## Calculation Engine Integration

### How It Works

1. **Input Reception**: Raw data comes from ETL or API
2. **Validation**: Required fields are validated
3. **Calculation**: The calculation engine computes all derived fields
4. **Rounding**: Appropriate rounding policies applied based on context:
   - Storage: 6 decimal places
   - Display: 2 decimal places (dollars)
   - Special cases: YouTube CPV uses 3 decimal places
5. **Metadata**: Each calculation includes version and timestamp
6. **Persistence**: Both raw and calculated values stored in MongoDB

### Example Campaign Creation Flow

```javascript
// Input from ETL/API
{
  name: "Summer Campaign 2025",
  campaignNumber: "CN-2025-001",
  budget: {
    total: 100000,
    allocated: 80000,
    spent: 45000
  }
}

// After Processing
{
  name: "Summer Campaign 2025",
  campaignNumber: "CN-2025-001",
  budget: {
    total: 100000,
    allocated: 80000,
    spent: 45000,
    remaining: 55000  // Calculated
  },
  calculatedFields: {
    allocationPercentage: {
      value: Decimal128("80.000000"),
      calculationVersion: "1.0.0",
      calculatedAt: "2025-01-26T10:00:00Z",
      context: "campaign_budget",
      formula: "marginPercentage"
    },
    spendPercentage: {
      value: Decimal128("45.000000"),
      calculationVersion: "1.0.0",
      calculatedAt: "2025-01-26T10:00:00Z",
      context: "campaign_budget",
      formula: "marginPercentage"
    }
  },
  _id: ObjectId("..."),
  createdAt: "2025-01-26T10:00:00Z",
  updatedAt: "2025-01-26T10:00:00Z"
}
```

## Versioning and Audit Trail

Every calculated field maintains:

- **Version**: Which calculation engine version was used
- **Timestamp**: When the calculation occurred
- **Context**: Why/where the calculation was triggered
- **Formula**: Reference to the specific calculation used

This ensures complete auditability and allows for recalculation if business rules change.
